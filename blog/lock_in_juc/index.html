<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.ico" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/favicon.ico" media="(prefers-color-scheme: light)"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/_astro/inter-latin-400-normal.BOOGhInR.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/inter-latin-600-normal.D273HNI0.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-400-normal.CvHVDnm4.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-600-normal.DUWh3m6k.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://yonagi04.github.io/blog/lock_in_juc/"><!-- Primary Meta Tags --><title>JUCä¸“é¢˜â€”â€”Javaä¸­çš„é” | Yonagi&#39;s Sekai</title><meta name="title" content="JUCä¸“é¢˜â€”â€”Javaä¸­çš„é” | Yonagi's Sekai"><meta name="description" content="Article: JUCä¸“é¢˜â€”â€”Javaä¸­çš„é”"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://yonagi04.github.io/blog/lock_in_juc/"><meta property="og:title" content="JUCä¸“é¢˜â€”â€”Javaä¸­çš„é” | Yonagi's Sekai"><meta property="og:description" content="Article: JUCä¸“é¢˜â€”â€”Javaä¸­çš„é”"><meta property="og:image" content="https://yonagi04.github.io/nano.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://yonagi04.github.io/blog/lock_in_juc/"><meta property="twitter:title" content="JUCä¸“é¢˜â€”â€”Javaä¸­çš„é” | Yonagi's Sekai"><meta property="twitter:description" content="Article: JUCä¸“é¢˜â€”â€”Javaä¸­çš„é”"><meta property="twitter:image" content="https://yonagi04.github.io/nano.png"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script>
  function init() {
    preloadTheme();
    onScroll();
    animate();

    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", (event) => scrollToTop(event));

    const backToPrev = document.getElementById("back-to-prev");
    backToPrev?.addEventListener("click", () => window.history.back());

    const lightThemeButton = document.getElementById("light-theme-button");
    lightThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "light");
      toggleTheme(false);
    });

    const darkThemeButton = document.getElementById("dark-theme-button");
    darkThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "dark");
      toggleTheme(true);
    });

    const systemThemeButton = document.getElementById("system-theme-button");
    systemThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "system");
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    });

    window.matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", event => {
        if (localStorage.theme === "system") {
          toggleTheme(event.matches);
        }
      }
    );

    document.addEventListener("scroll", onScroll);
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function onScroll() {
    if (window.scrollY > 0) {
      document.documentElement.classList.add("scrolled");
    } else {
      document.documentElement.classList.remove("scrolled");
    }
  }

  function scrollToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  }

function toggleTheme(dark) {
    const css = document.createElement("style");

    css.appendChild(
      document.createTextNode(
        `* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `,
      )
    );

    document.head.appendChild(css);

    if (dark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

  window.getComputedStyle(css).opacity;
    document.head.removeChild(css);
  }

  function preloadTheme() {
    const userTheme = localStorage.theme;

    if (userTheme === "light" || userTheme === "dark") {
      toggleTheme(userTheme === "dark");
    } else {
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    }
  }

  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
  preloadTheme();
</script><link rel="stylesheet" href="/_astro/_slug_.DNSn8Jsb.css"><script type="module" src="/_astro/hoisted.RlhmG3H2.js"></script></head> <body> <header> <link rel="stylesheet" href="https://unpkg.com/katex@0.16.9/dist/katex.min.css" integrity="sha384-5IMT6/8xSOPdFjD/xHw5/R5S8QvP4sYf6T0rXG6L4PjS0N0J5O5F4M0E0X0F0V0F" crossorigin="anonymous"> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/">  <div class="font-semibold"> Yonagi&#39;s Sekai </div>  </a> <nav class="flex gap-1"> <a href="/blog"> 
Blog
 </a> <span>    </span> <a href="/rss.xml" class="flex items-center px-2 underline" aria-label="RSS Feed">  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white-500"> <circle cx="6.18" cy="17.82" r="2.18"></circle> <path d="M4 4.44v3.06a12.5 12.5 0 0 1 12.5 12.5h3.06C19.56 10.61 13.39 4.44 4 4.44z"></path> <path d="M4 10.69v3.06a6.25 6.25 0 0 1 6.25 6.25h3.06A9.31 9.31 0 0 0 4 10.69z"></path> </svg>  </a> </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5"> <div class="space-y-1 my-10"> <div class="animate text-2xl font-semibold text-black dark:text-white"> JUCä¸“é¢˜â€”â€”Javaä¸­çš„é” </div> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2024-05-19T12:49:35.000Z"> 2024å¹´5æœˆ19æ—¥ </time> </div>
&bull;
<div class="font-base text-sm"> 6 min read </div> </div> <div class="animate font-base text-sm">
Categories: æœªåˆ†ç±» </div> <div class="animate font-base text-sm">
Tags: æ—  </div> </div> <article class="animate"> <p><strong>æœ¬æ–‡éƒ¨åˆ†å†…å®¹èŠ‚é€‰è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</strong></p>
<blockquote>
<p>ğŸš€ <a href="https://yonagi04.github.io/posts/2024/bc3a3d7c4c51/">åŸºç¡€ï¼ˆä¸Šï¼‰</a> â†’ ğŸš€ <a href="https://yonagi04.github.io/posts/2024/da1a14d471aa/">åŸºç¡€ï¼ˆä¸­ï¼‰</a> â†’ ğŸš€<a href="https://yonagi04.github.io/posts/2024/3c15992991b1/">åŸºç¡€ï¼ˆä¸‹ï¼‰</a> â†’ ğŸ¤©<a href="https://yonagi04.github.io/posts/2024/2dcdc762ee3e/">é›†åˆï¼ˆä¸Šï¼‰</a> â†’ ğŸ¤©<a href="https://yonagi04.github.io/posts/2024/5972154ca625/">é›†åˆï¼ˆä¸‹ï¼‰</a> â†’ ğŸ¤—<a href="https://yonagi04.github.io/posts/2024/4e86d54ab314/">JVMä¸“é¢˜1</a> â†’ ğŸ¤—<a href="https://yonagi04.github.io/posts/2024/82639aae6f65/">JVMä¸“é¢˜2</a> â†’ ğŸ¤—<a href="https://yonagi04.github.io/posts/2024/7a285a73570d/">JVMä¸“é¢˜3</a> â†’ ğŸ¤—<a href="https://yonagi04.github.io/posts/2024/fddd546e0d7f/">JVMä¸“é¢˜4</a> â†’ğŸ˜‹<a href="https://yonagi04.github.io/posts/2024/6eeebc171f9e/">JUCä¸“é¢˜1</a> â†’ ğŸ˜‹<a href="https://yonagi04.github.io/posts/2024/8b5f9ea51b60/">JUCä¸“é¢˜2</a> â†’ ğŸ˜‹<a href="https://yonagi04.github.io/posts/2024/b64cc63dd695/">JUCä¸“é¢˜3</a></p>
</blockquote>
<h1 id="lockæ¥å£">Lockæ¥å£</h1>
<p>é”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼, ä¸€èˆ¬æ¥è¯´, ä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æº (ä½†æ˜¯æœ‰äº›é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®å…±äº«èµ„æº, æ¯”å¦‚è¯»å†™é”)</p>
<p>ä½¿ç”¨ <code>synchronized</code> å…³é”®å­—å°†ä¼šéšå¼åœ°è·å¾—é”, ä½†æ˜¯å®ƒå°†é”çš„è·å–å’Œé‡Šæ”¾å›ºåŒ–äº†, ä¹Ÿå°±æ˜¯å…ˆè·å–å†é‡Šæ”¾. å½“ç„¶è¿™ç§æ–¹å¼ç®€åŒ–äº†åŒæ­¥çš„ç®¡ç†, å¯æ˜¯æ‰©å±•æ€§æ²¡æœ‰æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾æ¥çš„å¥½</p>
<h1 id="é˜Ÿåˆ—åŒæ­¥å™¨">é˜Ÿåˆ—åŒæ­¥å™¨</h1>
<p><strong>é˜Ÿåˆ—åŒæ­¥å™¨</strong> æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶, ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€, é€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œ</p>
<p>åŒæ­¥å™¨çš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿, å­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨å¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€, åœ¨æŠ½è±¡æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸­å…ä¸äº†è¦å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œè¿‡å‘¢æ›´æ”¹, è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„ 3 ä¸ªæ–¹æ³•(<code>getState()</code> , <code>setState(int state)</code> , <code>compareAndSetState(int expect, int update)</code>) æ¥è¿›è¡Œæ“ä½œ, å› ä¸ºå®ƒä»¬èƒ½å¤Ÿä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯å®‰å…¨çš„</p>
<h2 id="é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£">é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£</h2>
<p>é‡å†™åŒæ­¥å™¨æŒ‡å®šçš„æ–¹æ³•æ—¶, éœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„å¦‚ä¸‹ 3 ä¸ªæ–¹æ³•æ¥è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€</p>
<ul>
<li><code>getState()</code> : è·å–åŒæ­¥çŠ¶æ€</li>
<li><code>setState()</code> : è®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€</li>
<li><code>compareAndSetState()</code> : ä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€, è¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§</li>
</ul>
<p>åŒæ­¥å™¨å¯é‡å†™çš„æ–¹æ³•å¦‚ä¸‹</p>





























<table><thead><tr><th>æ–¹æ³•åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>protected boolean tryAcquire(int arg)</code></td><td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€, å®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸ, ç„¶åå†è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€</td></tr><tr><td><code>protected boolean tryRelease(int arg)</code></td><td>ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€, ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†ä¼šæœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€</td></tr><tr><td><code>protected int tryAcquireShared(int arg)</code></td><td>å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€, è¿”å›å¤§äºç­‰äº0 çš„å€¼, è¡¨ç¤ºè·å–æˆåŠŸ, åä¹‹, è·å–å¤±è´¥</td></tr><tr><td><code>protected boolean tryReleaseShared(int arg)</code></td><td>å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</td></tr><tr><td><code>protected boolean isHeldExclusively()</code></td><td>å½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨, ä¸€èˆ¬è¯¥æ–¹æ³•è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å </td></tr></tbody></table>
<p>å®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶, å°†ä¼šè°ƒç”¨åŒæ­¥é”çš„æ¨¡æ¿æ–¹æ³•</p>













































<table><thead><tr><th>æ–¹æ³•åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>void acquire(int arg)</code></td><td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€, å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸ, åˆ™ç”±è¯¥æ–¹æ³•è¿”å›, å¦åˆ™, å°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…, è¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨é‡å†™çš„ <code>tryAcquire(int arg)</code> æ–¹æ³•</td></tr><tr><td><code>void acquireInterruptibly(int arg)</code></td><td>ä¸ <code>acquire(int arg)</code> ç›¸åŒ, ä½†æ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­, å½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­, å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­, åˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡º <code>InterruptedException</code> å¹¶è¿”å›</td></tr><tr><td><code>boolean tryAcquireNanos(int arg, long nanos)</code></td><td>åœ¨<code>acquireInterruptibly(int arg)</code> åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶, å¦‚æœåœ¨è¶…æ—¶é™åˆ¶å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€, åˆ™è¿”å› <code>false</code>, å¦åˆ™è¿”å› <code>true</code></td></tr><tr><td><code>void acquireShared(int arg)</code></td><td>å…±äº«å¼çš„è·å–åŒæ­¥çŠ¶æ€, å¦‚æœå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€, å°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…, ä¸ç‹¬å å¼è·å–çš„ä¸»è¦åŒºåˆ«æ˜¯åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€</td></tr><tr><td><code>void acquireSharedInterruptibly(int arg)</code></td><td>ä¸ <code>acquireShared(int arg)</code> ä¸€æ ·, è¯¥æ–¹æ³•å“åº”ä¸­æ–­</td></tr><tr><td><code>boolean tryAcquireSharedNanos(int arg, long nanos)</code></td><td>åœ¨ <code>acquireSharedInterruptibly(int arg)</code> çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶</td></tr><tr><td><code>boolean release(int arg)</code></td><td>ç‹¬å å¼çš„é‡Šæ”¾åŒæ­¥çŠ¶æ€, è¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹å, å°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’</td></tr><tr><td><code>boolean releaseShared(int arg)</code></td><td>å…±äº«å¼çš„é‡Šæ”¾åŒæ­¥çŠ¶æ€</td></tr><tr><td><code>Collection&#x3C;Thread> getQueuedThreads()</code></td><td>è·å–ç­‰å¾…åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹é›†åˆ</td></tr></tbody></table>
<h2 id="é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ">é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ</h2>
<h3 id="åŒæ­¥é˜Ÿåˆ—">åŒæ­¥é˜Ÿåˆ—</h3>
<p>åŒæ­¥å™¨ä¾èµ–äºå†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†, å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶, åŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹åŠå…¶ç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—, åŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹, å½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶, ä¼šæŠŠé¦–èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’, ä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img/img/content/node.webp" alt=""></p>
<p>èŠ‚ç‚¹æ˜¯æ„æˆåŒæ­¥é˜Ÿåˆ—çš„åŸºç¡€, åŒæ­¥å™¨å…·æœ‰å¤´èŠ‚ç‚¹(head)å’Œå°¾èŠ‚ç‚¹(tail), æ²¡æœ‰æˆåŠŸè·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†ä¼šæˆä¸ºèŠ‚ç‚¹åŠ å…¥è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨, åŒæ­¥é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.4/img/content/sync-queue.webp" alt=""></p>
<p>åŒæ­¥å™¨å°†èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.4/img/content/add-sync-queue.webp" alt=""></p>
<p>åŒæ­¥é˜Ÿåˆ—éµå¾ªFIFO, é¦–èŠ‚ç‚¹æ˜¯åŒæ­¥çŠ¶æ€è·å–æˆåŠŸçš„èŠ‚ç‚¹, é¦–èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶, ä¼šå”¤é†’åç»§èŠ‚ç‚¹, è€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.4/img/content/headnode.webp" alt=""></p>
<p>è®¾ç½®é¦–èŠ‚ç‚¹æ˜¯é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„çº¿ç¨‹æ¥å®Œæˆçš„, ç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€, å› æ­¤è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•ä¸éœ€è¦ç”¨CASæ¥ä¿è¯, å®ƒåªéœ€è¦å°†é¦–èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯</p>
<h3 id="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾">ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h3>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„ <code>acquire(int arg)</code> æ–¹æ³•å¯ä»¥è·å–åŒæ­¥çŠ¶æ€, è¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿ, ä¹Ÿå°±æ˜¯ç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­, åç»­å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶, çº¿ç¨‹ä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»å‡º</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// åŒæ­¥å™¨çš„acquireæ–¹æ³•</span></span>
<span class="line"><span>public final void acquire(int arg) {</span></span>
<span class="line"><span>    if (!tryAcquire(arg) &#x26;&#x26; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) {</span></span>
<span class="line"><span>        selfInterrupt();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// åŒæ­¥å™¨çš„addWaiterå’Œenqæ–¹æ³•</span></span>
<span class="line"><span>private Node addWaiter(Node mode) {</span></span>
<span class="line"><span>    Node node = new Node(Thread.currentThread(), mode);</span></span>
<span class="line"><span>    Node pred = tail;</span></span>
<span class="line"><span>    if (pred != null) {</span></span>
<span class="line"><span>        node.prev = pred;</span></span>
<span class="line"><span>        if (compareAndSetTail(pred, node)) {</span></span>
<span class="line"><span>            pred.next = node;</span></span>
<span class="line"><span>            return node;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    enq(node);</span></span>
<span class="line"><span>    return node;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Ndoe enq(final Node node) {</span></span>
<span class="line"><span>    for (;;) {</span></span>
<span class="line"><span>        Node t = tail;</span></span>
<span class="line"><span>        if (t == null) {</span></span>
<span class="line"><span>            if (compareAndSetHead(new Node())) {</span></span>
<span class="line"><span>                tail = head;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            node.prev = t;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        if (compareAndSetTail(t, node)) {</span></span>
<span class="line"><span>            t.next = node;</span></span>
<span class="line"><span>            return t;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre>
<p>èŠ‚ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹å, å°±è¿›å…¥äº†è‡ªæ—‹, æ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨è‡ªçœåœ°è§‚å¯Ÿ, å½“æ¡ä»¶æ»¡è¶³, è·å–åˆ°äº†åŒæ­¥çŠ¶æ€, å°±ä»è‡ªæ—‹çŠ¶æ€ä¸­é€€å‡º, å¦åˆ™ä¾æ—§ç•™åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#6A737D">// åŒæ­¥å™¨çš„acquireQueuedæ–¹æ³•</span></span>
<span class="line"><span style="color:#F97583">final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> acquireQueued</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Node node, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> arg) {</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#E1E4E8"> failed </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        boolean</span><span style="color:#E1E4E8"> interrupted </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (;;) {</span></span>
<span class="line"><span style="color:#F97583">            final</span><span style="color:#E1E4E8"> Node p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> node.</span><span style="color:#B392F0">predecessor</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (p </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> head </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(arg)) {</span></span>
<span class="line"><span style="color:#B392F0">                setHead</span><span style="color:#E1E4E8">(node);</span></span>
<span class="line"><span style="color:#E1E4E8">                p.next </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                failed </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#E1E4E8"> interrupted;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">shouldParkAfterFailedAcquire</span><span style="color:#E1E4E8">(p, node) </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#B392F0"> parkAndCheckInterrupt</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">                interrupted </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (failed) {</span></span>
<span class="line"><span style="color:#B392F0">            cancelAcquire</span><span style="color:#E1E4E8">(node);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>åœ¨ <code>acquireQueued(final Node node, int arg)</code> æ–¹æ³•ä¸­, å½“å‰çº¿ç¨‹åœ¨â€æ­»å¾ªç¯â€ä¸­å°è¯•è·å–åŒæ­¥çŠ¶æ€, è€Œåªæœ‰å¤´èŠ‚ç‚¹æ‰èƒ½å°è¯•è·å–åŒæ­¥çŠ¶æ€, ä¸ºä»€ä¹ˆ?</p>
<ol>
<li>å¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹, è€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹å, å°†ä¼šå”¤é†’åç»­èŠ‚ç‚¹, åç»­èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’ä¹‹åéœ€è¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹</li>
<li>ç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™, è¯¥æ–¹æ³•ä¸­, èŠ‚ç‚¹è‡ªæ—‹è·å–åŒæ­¥çŠ¶æ€çš„è¡Œä¸ºå¦‚å›¾æ‰€ç¤º</li>
</ol>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.4/img/content/get-sync-status.webp" alt=""></p>
<p>èŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´åœ¨å¾ªç¯æ£€æŸ¥çš„è¿‡ç¨‹ä¸­åŸºæœ¬ä¸ç›¸äº’é€šä¿¡, è€Œæ˜¯ç®€å•çš„åˆ¤æ–­è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹, è¿™æ ·å°±ä½¿å¾—èŠ‚ç‚¹çš„é‡Šæ”¾è§„åˆ™ç¬¦åˆFIFO, å¹¶ä¸”ä¹Ÿä¾¿äºå¯¹è¿‡æ—©é€šçŸ¥çš„å¤„ç†(è¿‡æ—©é€šçŸ¥æ˜¯æŒ‡å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹çš„èŠ‚ç‚¹ç”±äºä¸­æ–­è€Œè¢«å”¤é†’)</p>
<p>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–æµç¨‹å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.5/img/content/exclusive-sync-state.webp" alt=""></p>
<p>å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¹¶æ‰§è¡Œäº†ç›¸åº”é€»è¾‘ä¹‹å, å°±éœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€, ä½¿å¾—åç»­èŠ‚ç‚¹èƒ½å¤Ÿç»§ç»­è·å–åŒæ­¥çŠ¶æ€, é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„ <code>release(int arg)</code> æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€, è¯¥æ–¹æ³•åœ¨é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹å, ä¼šå”¤é†’å…¶åç»­èŠ‚ç‚¹(è¿›è€Œä½¿åç»­èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€)</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// åŒæ­¥å™¨çš„releaseæ–¹æ³•</span></span>
<span class="line"><span>public final boolean release(int arg) {</span></span>
<span class="line"><span>    if (tryRelease(arg)) {</span></span>
<span class="line"><span>        Node h = head;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre>
<p>æ€»ç»“: åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶, åŒæ­¥å™¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—, è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶è¿›è¡Œè‡ªæ—‹; ç§»å‡ºé˜Ÿåˆ—çš„å‰ææ˜¯å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”èƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€. åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶, åŒæ­¥å™¨è°ƒç”¨ <code>tryRelease(int arg)</code> æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€, ç„¶åå”¤é†’å¤´èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹</p>
<h3 id="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾">å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h3>
<p>å…±äº«å¼è·å–ä¸ç‹¬å å¼è·å–æœ€å¤§çš„åŒºåˆ«åœ¨äºåŒä¸€æ—¶åˆ»æ˜¯å¦èƒ½æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°åŒæ­¥çŠ¶æ€.</p>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„ <code>acquireShared(int arg)</code> æ–¹æ³•å¯ä»¥å…±äº«å¼åœ°è·å–åˆ°åŒæ­¥çŠ¶æ€</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// åŒæ­¥å™¨çš„acquiredSharedå’ŒdoAcquireSharedæ–¹æ³•</span></span>
<span class="line"><span>public final void acquireShared(int arg) {</span></span>
<span class="line"><span>    if (tryAcquireShared(arg) &#x3C; 0) {</span></span>
<span class="line"><span>        doAcquireShared(arg);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void doAcquireShared(int arg) {</span></span>
<span class="line"><span>    final Node node = addWaiter(Node.SHARED);</span></span>
<span class="line"><span>    boolean failed = true;</span></span>
<span class="line"><span>    try {</span></span>
<span class="line"><span>        boolean interrupted = false;</span></span>
<span class="line"><span>        for (;;) {</span></span>
<span class="line"><span>            final Node p = node.predecessor();</span></span>
<span class="line"><span>            if (p == head) {</span></span>
<span class="line"><span>                int r = tryAcquireShared(arg);</span></span>
<span class="line"><span>                if (r >= 0) {</span></span>
<span class="line"><span>                    setHeadAndPropagate(node, r);</span></span>
<span class="line"><span>                    p.next = NULL;</span></span>
<span class="line"><span>                    if (interrupted)</span></span>
<span class="line"><span>                        selfInterrupt();</span></span>
<span class="line"><span>                   	failed = false;</span></span>
<span class="line"><span>                    return;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            if (shouldParkAfterFailedAcquire(p, node) &#x26;&#x26; parkAndCheckInterrupt())</span></span>
<span class="line"><span>                interrupted = true;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    } finally {</span></span>
<span class="line"><span>        if (failed) {</span></span>
<span class="line"><span>            cancelAcquire(node);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre>
<p>å…±äº«å¼è·å–ä¹Ÿéœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€, é€šè¿‡è°ƒç”¨ <code>releaseShared(int arg)</code> æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> releaseShared</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> arg) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tryReleaseShared</span><span style="color:#E1E4E8">(arg)) {</span></span>
<span class="line"><span style="color:#B392F0">        doReleaseShared</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€">ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€</h3>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„ <code>doAcquireNanos(int arg, long nanoTimeout)</code> æ–¹æ³•å¯ä»¥è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€, å³åœ¨æŒ‡å®šçš„æ—¶é—´æ®µå†…è·å–åŒæ­¥çŠ¶æ€, å¦‚æœè·å–åˆ°åŒæ­¥çŠ¶æ€åˆ™è¿”å› true, å¦åˆ™, è¿”å› false</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> doAcquireNanos</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> arg, </span><span style="color:#F97583">long</span><span style="color:#E1E4E8"> nanoTimeout) throws InterruptedException {</span></span>
<span class="line"><span style="color:#F97583">    long</span><span style="color:#E1E4E8"> lastTime </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    final</span><span style="color:#E1E4E8"> Node node </span><span style="color:#F97583">=</span><span style="color:#B392F0"> addWaiter</span><span style="color:#E1E4E8">(Node.EXCLUSIVE);</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#E1E4E8"> failed </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (;;) {</span></span>
<span class="line"><span style="color:#F97583">            final</span><span style="color:#E1E4E8"> Node p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> node.</span><span style="color:#B392F0">predecessor</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (p </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> head </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(arg)) {</span></span>
<span class="line"><span style="color:#B392F0">                setHead</span><span style="color:#E1E4E8">(node);</span></span>
<span class="line"><span style="color:#E1E4E8">                p.next </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                failed </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (nanosTimeout </span><span style="color:#F97583">&#x3C;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">shouldParkAfterFailedAcquire</span><span style="color:#E1E4E8">(p, node) </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> nanosTimeout </span><span style="color:#F97583">></span><span style="color:#E1E4E8"> spinForTimeoutThreshold)</span></span>
<span class="line"><span style="color:#E1E4E8">                LockSupport.</span><span style="color:#B392F0">parkNanos</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, nanosTimeout);</span></span>
<span class="line"><span style="color:#F97583">          	long</span><span style="color:#E1E4E8"> now </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">            nanosTimeout </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> now </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> lastTime;</span></span>
<span class="line"><span style="color:#E1E4E8">            lastTime </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> out;</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (Thread.</span><span style="color:#B392F0">interrupted</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> InterruptedException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (failed) {</span></span>
<span class="line"><span style="color:#B392F0">            cancelAcquire</span><span style="color:#E1E4E8">(node);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.9/img/content/exclusive-timeout-sync-state.webp" alt=""></p>
<h1 id="é‡å…¥é”">é‡å…¥é”</h1>
<p>é‡å…¥é” ReentrantLock, é¡¾åæ€ä¹‰å°±æ˜¯æ”¯æŒé‡è¿›å…¥çš„é”,å®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”. é™¤æ­¤ä¹‹å¤–è¿˜æ”¯æŒè·å–é”æ—¶çš„å…¬å¹³å’Œéå…¬å¹³æ€§é€‰æ‹©</p>
<p>ReentrantLockè™½ç„¶æ²¡åƒsynchronizedå…³é”®å­—ä¸€æ ·æ”¯æŒéšå¼çš„é‡è¿›å…¥, ä½†æ˜¯åœ¨è°ƒç”¨ <code>lock()</code> æ–¹æ³•æ—¶, å·²ç»è·å–åˆ°é”çš„è¿›ç¨‹, èƒ½å¤Ÿå†æ¬¡è°ƒç”¨ <code>lock()</code> æ–¹æ³•è·å–é”è€Œä¸è¢«é˜»å¡</p>
<h2 id="å®ç°é‡è¿›å…¥">å®ç°é‡è¿›å…¥</h2>
<p><strong>é‡è¿›å…¥</strong>æ˜¯æŒ‡ä»»æ„çº¿ç¨‹åœ¨è·å¾—åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–åˆ°é”è€Œä¸ä¼šè¢«é˜»å¡</p>
<p>ReentrantLocké€šè¿‡ç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°é”çš„è·å–å’Œé‡Šæ”¾. ä»¥éå…¬å¹³æ€§å®ç°ä¸ºä¾‹, è·å–åŒæ­¥çŠ¶æ€çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> nonfairTryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> acquires) {</span></span>
<span class="line"><span style="color:#F97583">    final</span><span style="color:#E1E4E8"> Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compareAnsSetState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, acquires)) {</span></span>
<span class="line"><span style="color:#B392F0">            setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (current </span><span style="color:#F97583">==</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (nextc </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Maximum lock count exceeded"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#B392F0">        setState</span><span style="color:#E1E4E8">(nextc);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>æˆåŠŸè·å–é”çš„çº¿ç¨‹å†æ¬¡è·å–é”, åªæ˜¯å¢åŠ äº†åŒæ­¥çŠ¶æ€å€¼, è¿™ä¹Ÿå°±è¦æ±‚ ReentrantLockåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶å‡å°‘åŒæ­¥çŠ¶æ€å€¼, è¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryRelease</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> releases) {</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> releases;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> IllegalMonitorStateException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#E1E4E8"> free </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        free </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">        setExclusiveOwnerThread</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    setState</span><span style="color:#E1E4E8">(c);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> free;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="å…¬å¹³ä¸éå…¬å¹³è·å¾—é”çš„åŒºåˆ«">å…¬å¹³ä¸éå…¬å¹³è·å¾—é”çš„åŒºåˆ«</h2>
<p>å¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„, é‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚çš„ç»å¯¹æ—¶é—´é¡ºåº</p>
<p>å…¬å¹³é”çš„è·å–åŒæ­¥çŠ¶æ€ä»£ç å¦‚ä¸‹</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> acquires) {</span></span>
<span class="line"><span style="color:#F97583">    final</span><span style="color:#E1E4E8"> Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">hasQueuedPredecessors</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#B392F0"> compareAndSetState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, acquires)) {</span></span>
<span class="line"><span style="color:#B392F0">            setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (current </span><span style="color:#F97583">==</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (nextc </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Maximum lock count exceeded"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#B392F0">        setState</span><span style="color:#E1E4E8">(nextc);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>éå…¬å¹³é”å¯èƒ½å¯¼è‡´çº¿ç¨‹â€é¥¥é¥¿â€, ä½†æ˜¯æå°‘çš„çº¿ç¨‹åˆ‡æ¢ä¿è¯äº†æ›´å¤§çš„ååé‡</p>
<h1 id="è¯»å†™é”">è¯»å†™é”</h1>
<p>è¯»å†™é”åœ¨åŒä¸€æ—¶åˆ»å…è®¸å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®, ä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶, å…¶ä»–çš„è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡. è¯»å†™é”ç»´æŠ¤äº†ä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”, é€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”, ä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰å¾ˆå¤§çš„æå‡</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹è¯»å†™é”çš„æ€§èƒ½æ¯”æ’ä»–é”è¦å¥½, è¿™æ˜¯å› ä¸ºå¤§å¤šæ•°åœºæ™¯æ˜¯è¯»å¤§äºå†™çš„. åœ¨è¯»å¤§äºå†™çš„æƒ…å†µä¸‹, è¯»å†™é”èƒ½å¤Ÿæä¾›æ¯”æ’ä»–é”æ›´å¥½çš„å¹¶å‘æ€§å’Œååé‡. Javaå®ç°è¯»å†™é”æ˜¯ ReentrantReadWriteLock, å®ƒçš„ç‰¹æ€§å¦‚ä¸‹</p>





















<table><thead><tr><th>ç‰¹æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å…¬å¹³æ€§é€‰æ‹©</td><td>æ”¯æŒéå…¬å¹³(é»˜è®¤)ä¸å…¬å¹³çš„é”è·å–æ–¹å¼, ååé‡éå…¬å¹³ä¼˜äºå…¬å¹³</td></tr><tr><td>é‡è¿›å…¥</td><td>è¯¥é”æ”¯æŒé‡è¿›å…¥, ä»¥è¯»å†™çº¿ç¨‹ä¸ºä¾‹: è¯»çº¿ç¨‹è·å–è¯»é”åèƒ½å¤Ÿå†æ¬¡è·å–è¯»é”, å†™çº¿ç¨‹è·å–å†™é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å¾—å†™é”, ä¹Ÿèƒ½è·å¾—è¯»é”</td></tr><tr><td>é”é™çº§</td><td>éµå¾ªè·å–å†™é”, è·å–è¯»é”å†é‡Šæ”¾å†™é”çš„æ¬¡åº, å†™é”èƒ½å¤Ÿé™çº§ä¸ºè¯»é”</td></tr></tbody></table>
<h2 id="è¯»å†™é”çš„æ¥å£">è¯»å†™é”çš„æ¥å£</h2>
<p>ReadWriteLockä»…å®šä¹‰äº†è·å–è¯»é”ä¸å†™é”çš„ä¸¤ä¸ªæ–¹æ³•, å³ <code>readLock()</code> æ–¹æ³•å’Œ <code>writeLock()</code> æ–¹æ³•, è€Œå…¶å®ç° <code>ReentrantReadWriteLock</code> , é™¤äº†æ¥å£æ–¹æ³•å¤–è¿˜æä¾›äº†ä¸€äº›ä¾¿äºå¤–ç•Œç›‘æ§å…¶å†…éƒ¨å·¥ä½œçŠ¶æ€çš„æ–¹æ³•</p>

























<table><thead><tr><th>æ–¹æ³•åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>int getReadLockCount()</td><td>è¿”å›å½“å‰è¯»é”è¢«è·å–çš„æ¬¡æ•°. è¯¥æ¬¡æ•°ä¸ç­‰äºè·å–è¯»é”çš„çº¿ç¨‹æ•°</td></tr><tr><td>int getReadHoldCount()</td><td>è¿”å›å½“å‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°</td></tr><tr><td>boolean isWriteLocked()</td><td>åˆ¤æ–­å†™é”æ˜¯å¦è¢«è·å–</td></tr><tr><td>int getWriteHoldCount()</td><td>è¿”å›å½“å‰å†™é”è¢«è·å–çš„æ¬¡æ•°</td></tr></tbody></table>
<h2 id="è¯»å†™é”çš„å®ç°åˆ†æ">è¯»å†™é”çš„å®ç°åˆ†æ</h2>
<h3 id="è¯»å†™çŠ¶æ€çš„è®¾è®¡">è¯»å†™çŠ¶æ€çš„è®¾è®¡</h3>
<p>è¯»å†™é”ä¾èµ–äºè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°åŒæ­¥åŠŸèƒ½, è€Œè¯»å†™çŠ¶æ€å°±æ˜¯å…¶åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€.</p>
<p>è¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€(ä¸€ä¸ªæ•´å‹å˜é‡)ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€, ä½¿å¾—è¯¥çŠ¶æ€çš„è®¾è®¡æˆä¸ºè¯»å†™é”å®ç°çš„å…³é”®</p>
<p>å¦‚æœåœ¨ä¸€ä¸ªæ•´å‹å˜é‡ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€, å°±ä¸€å®šéœ€è¦ â€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€ è¿™ä¸ªå˜é‡, è¯»å†™é”å°†å˜é‡åˆ‡åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†, é«˜16ä½è¡¨ç¤ºè¯», ä½16ä½è¡¨ç¤ºå†™</p>
<p><img src="https://unpkg.com/yonagi-blog-repo-img@1.1.9/img/content/read-write-lock-state-divide.webp" alt=""></p>
<p>å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€ä¸ºS, å½“Sä¸ç­‰äº0æ—¶, å½“å†™çŠ¶æ€ (S &#x26; 0x0000FFFF) ç­‰äº 0 æ—¶, åˆ™è¯»çŠ¶æ€ (S >>> 16) å¤§äº 0, å³è¯»é”å·²è¢«è·å–</p>
<h3 id="å†™é”çš„è·å–å’Œé‡Šæ”¾">å†™é”çš„è·å–å’Œé‡Šæ”¾</h3>
<p>å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’å®ƒé”. å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°äº†å†™é”, åˆ™å¢åŠ å†™çŠ¶æ€. å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶, è¯»é”å·²ç»è¢«è·å–æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–åˆ°å†™é”çš„çº¿ç¨‹, é‚£ä¹ˆè¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€</p>
<p>è·å–å†™é”çš„ä»£ç å¦‚ä¸‹</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8">    Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> w </span><span style="color:#F97583">=</span><span style="color:#B392F0"> exclusiveCount</span><span style="color:#E1E4E8">(c);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (w </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> current </span><span style="color:#F97583">!=</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (w </span><span style="color:#F97583">+</span><span style="color:#B392F0"> exclusiveCount</span><span style="color:#E1E4E8">(acquires) </span><span style="color:#F97583">></span><span style="color:#E1E4E8"> MAX_COUNT) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Maximum lock count exceeded"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#B392F0">        setState</span><span style="color:#E1E4E8">(c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">writerShouldBlock</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">||</span><span style="color:#F97583"> !</span><span style="color:#B392F0">compareAndSetState</span><span style="color:#E1E4E8">(c, c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires)) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>å†™é”çš„é‡Šæ”¾å’ŒReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼, æ¯æ¬¡é‡Šæ”¾éƒ½å‡å°‘å†™çŠ¶æ€, å½“å†™çŠ¶æ€ä¸º 0 æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾, ä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹å¯ä»¥ç»§ç»­è®¿é—®å†™é”, åŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­çº¿ç¨‹æ˜¯å¯è§çš„</p>
<h3 id="è¯»é”çš„è·å–å’Œé‡Šæ”¾">è¯»é”çš„è·å–å’Œé‡Šæ”¾</h3>
<p>è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”, å®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–, åœ¨æ²¡æœ‰å…¶ä»–å†™çº¿ç¨‹è®¿é—®æ—¶, è¯»é”æ€»èƒ½æˆåŠŸè·å–åˆ°. å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°äº†è¯»é”, åˆ™å¢åŠ è¯»çŠ¶æ€. å¦‚æœå½“å‰çº¿ç¨‹åœ¨è¯•å›¾è·å–è¯»é”æ—¶, å†™é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹è·å–, åˆ™è¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€</p>
<p>è·å–è¯»é”çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> tryAcquireShared</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> unused) {</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (;;) {</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (nextc </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> c) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Maximum lock count exceeded"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">exclusiveCount</span><span style="color:#E1E4E8">(c) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> owner </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compareAndSetState</span><span style="color:#E1E4E8">(c, nextc)) {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="é”é™çº§">é”é™çº§</h3>
<p>é”é™çº§æ˜¯æŒ‡å†™é”é™çº§ä¸ºè¯»é”. å…·ä½“æ¥è®², é”é™çº§æ˜¯æŒ‡æŠŠæŒä½å½“å‰æ‹¥æœ‰çš„å†™é”, ç„¶åè·å–è¯»é”, æœ€ååœ¨é‡Šæ”¾å†™é”çš„è¿‡ç¨‹</p>
<p>é”é™çº§ä¸­æ˜¯å¦æœ‰å¿…è¦è·å–è¯»é”? ç­”æ¡ˆæ˜¯å¿…è¦çš„, ç›®çš„æ˜¯ä¸ºäº†æ•°æ®çš„å¯è§æ€§. å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸è·å–è¯»é”è€Œç›´æ¥é‡Šæ”¾äº†å†™é”, æ­¤æ—¶è‹¥å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®, å½“å‰çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°æ•°æ®å¦ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®æ›´æ–°. å‡è®¾å½“å‰çº¿ç¨‹è·å–äº†è¯»é”, éµå¾ªé”é™çº§çš„æ­¥éª¤, å¦ä¸€ä¸ªè¯•å›¾è·å–å†™é”çš„çº¿ç¨‹å°±ä¼šè¢«é˜»å¡, ç›´åˆ°å½“å‰çº¿ç¨‹ä½¿ç”¨å®Œæ•°æ®å¹¶é‡Šæ”¾æ‰è¯»é”ä¹‹å, å¦ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½è·å–åˆ°å†™é”è¿›è¡Œæ›´æ–°</p> </article>  </div>  </main> <footer class="animate"> <div class="mx-auto max-w-screen-sm px-5">   <div class="flex justify-between items-center"> <div>
&copy; 2025 | Yonagi&#39;s Sekai </div> <!-- <div class="flex flex-wrap gap-1 items-center">
        <button
          id="light-theme-button"
          aria-label="Light theme"
          class="group size-8 flex items-center justify-center rounded-full"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        <button
          id="dark-theme-button"
          aria-label="Dark theme"
          class="group size-8 flex items-center justify-center rounded-full"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <button
          id="system-theme-button"
          aria-label="System theme"
          class="group size-8 flex items-center justify-center rounded-full"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"
          >
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
        </button>
      </div> --> </div>  </div> </footer> </body></html>